# Kubernetes Multi-Controlplane and Multi-Node Cluster Setup with Vagrant and VMware Fusion

This setup uses Vagrant and VMware Fusion to create a multi controlplane and multi worker node Kubernetes cluster with a specified Kubernetes version and containerd as the container runtime. This setup works well with Apple Silicon M1/M2 chips.

## Prerequisites

- Install Vagrant
### On macOS:

1. **Using Homebrew:**

    ```sh
    brew install --cask vagrant
    ```

2. **Download from the official website:**

    - Visit the [Vagrant Downloads](https://www.vagrantup.com/downloads) page.
    - Download the macOS installer.
    - Open the downloaded `.dmg` file and follow the installation instructions.

### On Windows:

1. **Download from the official website:**

    - Visit the [Vagrant Downloads](https://www.vagrantup.com/downloads) page.
    - Download the Windows installer.
    - Run the installer and follow the installation instructions.

### On Linux:

1. **Using a package manager (Ubuntu/Debian):**

    ```sh
    sudo apt-get update
    sudo apt-get install -y vagrant
    ```

2. **Download from the official website:**

    - Visit the [Vagrant Downloads](https://www.vagrantup.com/downloads) page.
    - Download the appropriate package for your distribution.
    - Follow the installation instructions provided on the website.

### Verify Installation

After installation, verify that Vagrant is installed correctly by running:

```sh
vagrant --version

- Install VMware Fusion
### On macOS:

# Download VMware Fusion:
  - Visit the https://www.vmware.com/go/getfusion.
  - Download the VMware Fusion installer for macOS.

# Install VMware Fusion:
- Open the downloaded .dmg file.
- Drag the VMware Fusion icon to the Applications folder.
- Open VMware Fusion from the Applications folder and follow the installation instructions.

# Obtain a Personal Use License

1.  Visit the VMware Fusion Personal Use License page:
- Go to the Vhttps://customerconnect.vmware.com/web/vmware/evalcenter?p=fusion-player-personal page.

2. Sign in or create a VMware account:
- If you already have a VMware account, sign in.
- If you do not have a VMware account, create one by following the registration process.

3. Register for a Personal Use License:
- After signing in, follow the instructions to register for a personal use license.
- You will receive a license key that you can use to activate VMware Fusion.

# Activate VMware Fusion
1. Open VMware Fusion:
- If VMware Fusion is not already open, open it from the Applications folder.

2. Enter the License Key:
- When prompted, enter the license key you received from the VMware Fusion Personal Use License registration.

For more detailed instructions and additional information, refer to the official VMware Fusion documentation: https://docs.vmware.com/en/VMware-Fusion/index.html.

- Internet connection

## Setup

1. **Clone the repository**:
    ```sh
    git clone https://github.com/sunilnagendra89/kubernetes-multi-node-setup-using-vagrant-vmware-fusion.git
    cd kubernetes-multi-node-setup-using-vagrant-vmware-fusion
    ```

2. **Configure the Vagrantfile**:
    - Define the number of controlplane and worker nodes.
    - Set the Kubernetes version.

3. **Plugin Install**:
    ```sh
    vagrant plugin install vagrant-vmware-desktop
    ```

4. **Run Vagrant**:
    ```sh
    vagrant up
    ```

4. **Validate the Cluster**:
    ```sh
    vagrant ssh controlplane1
    bash /vagrant/scripts/validate_cluster.sh
    ```

## Vagrantfile

The Vagrantfile sets up the environment with the specified number of controlplane and worker nodes and installs the specified Kubernetes version.

## Shell Scripts

### `k8s_controlplane_setup.sh`

This script installs containerd and Kubernetes on the controlplane nodes, initializes the Kubernetes cluster, and installs the Calico network plugin. It also generates the join command for controlplane nodes and setup kubectl and kubernetes auto completion.

### `k8s_worker_setup.sh`

This script installs containerd and Kubernetes on the worker nodes and joins them to the Kubernetes cluster using the join command generated by the controlplane node.

### `validate_cluster.sh`

This script validates the Kubernetes cluster setup by checking the status of nodes and pods and verifying if Calico is running.

## Customization

- **Number of Nodes**: Modify the `NUM_CONTROLEPLANE` and `NUM_WORKERS` variables in the Vagrantfile.
- **Kubernetes Version**: Modify the `K8S_VERSION` variable in the Vagrantfile.

## Notes

- Ensure that the `join_command.sh` script is generated correctly by the controlplane node and is accessible by the worker nodes.
- The setup assumes a private network for inter-node communication with IP addresses in the range `192.168.50.x`.

## Troubleshooting

- If the worker nodes fail to join the cluster, check the `join_command.sh` script for the correct token and hash values.
- Ensure that all nodes have internet access to download necessary packages and dependencies.